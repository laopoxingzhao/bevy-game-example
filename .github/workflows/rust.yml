# 工作流名称，会在 GitHub Actions 界面中显示
name: Rust

# 定义触发工作流的事件
on:
  # 当推送到 main 分支时触发
  push:
    branches: [ "main" ]
  # 当创建针对 main 分支的拉取请求时触发
  pull_request:
    branches: [ "main" ]

# 定义环境变量
env:
  # 设置 Cargo 输出颜色，使日志更易读
  CARGO_TERM_COLOR: always

# 定义工作流中的任务
jobs:
  # 构建任务
  build:
    # 定义构建策略矩阵，可以同时在多个环境中运行
    strategy:
      matrix:
        # 操作系统矩阵，目前只包含 Windows 最新版本
        os: [windows-latest]
        
    # 指定运行环境，使用矩阵中的操作系统值
    runs-on: ${{ matrix.os }}

    # 定义执行步骤
    steps:
    # 第一步：检出代码仓库
    - uses: actions/checkout@v4
    
    # 第二步：安装 Rust 工具链
    - name: Install Rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        # 使用稳定的 Rust 版本
        toolchain: stable
        # 使用最小化的配置文件（只安装必要组件）
        profile: minimal
        # 覆盖现有工具链配置
        override: true
        
    # 第三步：编译项目（发布模式）
    - name: Build
      run: cargo build --release --verbose
      
    # 第四步：运行测试
    - name: Run tests
      run: cargo test --verbose
      
    # 第五步：上传构建产物（仅适用于 Windows）
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        # 定义上传文件的名称
        name: ppGame-${{ matrix.os }}
        # 指定要上传的文件路径
        path: target/release/ppGame.exe
      # 条件判断：仅在 Windows 环境下执行此步骤
      if: matrix.os == 'windows-latest'
      
    # 第六步：上传构建产物（适用于 Unix 系统）
    - name: Upload artifacts (Unix)
      uses: actions/upload-artifact@v4
      with:
        # 定义上传文件的名称
        name: ppGame-${{ matrix.os }}
        # 指定要上传的文件路径（Unix 系统无 .exe 扩展名）
        path: target/release/ppGame
      # 条件判断：仅在非 Windows 环境下执行此步骤
      if: matrix.os != 'windows-latest'